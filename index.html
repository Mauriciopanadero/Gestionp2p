<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Pedidos</title>
<style>
:root{
  --accent:#2c3e50;
  --ok:#27ae60;
  --muted:#666;
  --bg:#f8f8f8;
}
*{box-sizing:border-box}
body{
  font-family:Arial, sans-serif;
  margin:0;
  padding:20px;
  background:var(--bg);
  color:#222;
  -webkit-font-smoothing:antialiased;
}
h1{
  text-align:center;
  color:var(--accent);
  margin-bottom:12px;
  font-size:24px;
}

/* Controls */
.controls{
  text-align:center;
  margin-bottom:16px;
  display:flex;
  gap:10px;
  justify-content:center;
  flex-wrap:wrap;
}
button{
  padding:10px 16px;
  border-radius:10px;
  border:none;
  background:var(--accent);
  color:#fff;
  cursor:pointer;
  font-size:15px;
}
button[disabled]{ opacity:0.6; cursor:default; }

/* Days grid - tarjetas m√°s grandes */
.days{
  display:grid;
  gap:18px;
  grid-template-columns: repeat(3, 1fr);
  max-width:1200px;
  margin:0 auto;
  align-items:start;
}
.day-card{
  background:#fff;
  border-radius:14px;
  padding:28px 18px;
  text-align:center;
  font-weight:800;
  cursor:pointer;
  box-shadow:0 10px 30px rgba(0,0,0,0.06);
  transition:transform .12s ease, box-shadow .12s ease;
  border:1px solid #eee;
  min-height:120px;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  font-size:22px;
  line-height:1.05;
}
.day-card small{ display:block; font-weight:600; font-size:12px; color:var(--muted); margin-top:8px; text-transform:capitalize; }
.day-card:hover{ transform:translateY(-6px); box-shadow:0 18px 40px rgba(0,0,0,0.08); }
.day-card.verde{ background:var(--ok); color:#fff; border-color:rgba(0,0,0,0.06); }

/* Modal overlay */
.modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); align-items:center; justify-content:center; padding:18px; z-index:1000; }
.modal.open{ display:flex; }
.modal-content{ background:#fff; border-radius:12px; width:100%; max-width:920px; max-height:88vh; overflow:auto; padding:14px; }

/* Cafeter√≠a cards inside modal */
.caf-list{ display:flex; gap:16px; flex-wrap:wrap; padding-top:8px; }
.caf-card{ background:#fafafa; border-radius:12px; padding:18px; min-width:240px; max-width:340px; box-shadow:0 8px 24px rgba(0,0,0,0.06); cursor:pointer; border:1px solid #eee; display:flex; flex-direction:column; gap:8px; }
.caf-card h4{ margin:0; font-size:18px; color:var(--accent); }
.caf-card p{ margin:0; font-size:14px; color:var(--muted); }

/* Detalle pedido */
.detalle h3{ margin:6px 0; color:var(--accent); font-size:16px; }
.detalle ul{ list-style:none; padding:0; margin:0; }
.detalle li{ padding:8px 0; border-bottom:1px solid #f0f0f0; font-size:14px; }

/* Modal actions */
.modal-actions{ display:flex; gap:8px; margin-top:12px; justify-content:flex-end; flex-wrap:wrap; }
.btn-secondary{ background:#eee; color:#222; padding:8px 12px; border-radius:8px; border:none; cursor:pointer; }
.btn-primary{ background:var(--accent); color:#fff; padding:8px 12px; border-radius:8px; border:none; cursor:pointer; }

/* Close */
.close{ float:right; font-size:20px; cursor:pointer; border:none; background:transparent; }

/* Modal URLs list */
.urls-list{ list-style:none; padding:0; margin:8px 0 0; }
.urls-list li{ padding:8px 10px; border-bottom:1px solid #f0f0f0; display:flex; justify-content:space-between; align-items:center; gap:12px; }
.url-link{ color:var(--accent); text-decoration:none; font-weight:600; }
.url-note{ font-size:13px; color:var(--muted); }

/* Debug (oculto por defecto) */
.debug{ font-family:monospace; font-size:12px; background:#fff; padding:8px; border-radius:8px; margin-top:12px; max-height:120px; overflow:auto; border:1px solid #eee; display:none; }

/* Responsive */
@media (max-width:1000px){ .days{ grid-template-columns: repeat(2,1fr); } .day-card{ min-height:110px; font-size:20px; padding:22px 14px; } .caf-card{ min-width:200px; } }
@media (max-width:560px){
  .days{ grid-template-columns: 1fr; gap:12px; padding:0 8px; }
  .day-card{ min-height:96px; font-size:18px; padding:18px 12px; border-radius:12px; }
  .caf-card{ min-width:140px; max-width:100%; padding:14px; }
  .controls{ gap:8px; padding:0 8px; }
}
</style>
</head>
<body>

<h1>Dashboard de Pedidos</h1>
<div class="controls">
  <button id="prev">‚óÄ Anterior</button>
  <button id="next">Siguiente ‚ñ∂</button>
  <button id="refresh" aria-label="Refrescar pedidos">üîÑ Refrescar</button>
  <!-- Nuevo bot√≥n junto a Refrescar -->
  <button id="open-all-urls" aria-label="Ver todas las URLs">üåê Ver todas las URLs</button>
</div>

<div class="days" id="days-container"></div>

<!-- Modal cafeter√≠as -->
<div id="modal-cafs" class="modal" aria-hidden="true">
  <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="modal-cafs-title">
    <button class="close" id="close-cafs" aria-label="Cerrar">&times;</button>
    <h2 id="modal-cafs-title">Cafeter√≠as con pedidos</h2>

    <!-- bot√≥n para abrir modal de URLs (local al d√≠a) -->
    <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:8px;">
      <button id="btn-ver-urls" class="btn-secondary">Ver URLs</button>
    </div>

    <div id="caf-list" class="caf-list"></div>
    <div id="modal-cafs-note" style="margin-top:10px;color:var(--muted);font-size:13px"></div>
  </div>
</div>

<!-- Modal detalle pedido -->
<div id="modal-pedido" class="modal" aria-hidden="true">
  <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="modal-pedido-title">
    <button class="close" id="close-pedido" aria-label="Cerrar">&times;</button>
    <div id="pedido-content"></div>
    <div class="modal-actions">
      <button id="btn-regresar" class="btn-secondary">Regresar</button>
      <button id="btn-cerrar" class="btn-primary">Cerrar</button>
    </div>
  </div>
</div>

<!-- Modal URLs (global y local reutilizan este modal) -->
<div id="modal-urls" class="modal" aria-hidden="true">
  <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="modal-urls-title">
    <button class="close" id="close-urls" aria-label="Cerrar">&times;</button>
    <h2 id="modal-urls-title">URLs de cafeter√≠as</h2>
    <p class="url-note" id="urls-note" style="margin:6px 0 8px;color:var(--muted);font-size:13px"></p>
    <ul id="urls-list" class="urls-list"></ul>
    <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:12px;">
      <button id="btn-close-urls" class="btn-primary">Cerrar</button>
    </div>
  </div>
</div>

<div id="debug-log" class="debug"></div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const SUPABASE_URL = "https://pqphzdodpassomggthid.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBxcGh6ZG9kcGFzc29tZ2d0aGlkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1ODMxMTIsImV4cCI6MjA4MzE1OTExMn0.mQNeavAOItO-wTgfGVac-z91baYxsa6866HpBOZy3nM";
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

/* Elementos */
const container = document.getElementById("days-container");
const modalCafs = document.getElementById("modal-cafs");
const cafListEl = document.getElementById("caf-list");
const modalCafsNote = document.getElementById("modal-cafs-note");
const closeCafs = document.getElementById("close-cafs");
const btnVerUrls = document.getElementById("btn-ver-urls");

const modalPedido = document.getElementById("modal-pedido");
const pedidoContent = document.getElementById("pedido-content");
const closePedido = document.getElementById("close-pedido");
const btnRegresar = document.getElementById("btn-regresar");
const btnCerrar = document.getElementById("btn-cerrar");

const modalUrls = document.getElementById("modal-urls");
const urlsListEl = document.getElementById("urls-list");
const urlsNote = document.getElementById("urls-note");
const closeUrls = document.getElementById("close-urls");
const btnCloseUrls = document.getElementById("btn-close-urls");

const refreshBtn = document.getElementById("refresh");
const openAllUrlsBtn = document.getElementById("open-all-urls");
const debugLog = document.getElementById("debug-log");

closeCafs.onclick = () => cerrarModal(modalCafs);
closePedido.onclick = () => cerrarModal(modalPedido);
closeUrls.onclick = () => cerrarModal(modalUrls);
btnCerrar.onclick = () => cerrarModal(modalPedido);
btnRegresar.onclick = () => {
  cerrarModal(modalPedido);
  abrirModal(modalCafs);
};
btnCloseUrls.onclick = () => cerrarModal(modalUrls);

window.onclick = e => {
  if (e.target === modalCafs) cerrarModal(modalCafs);
  if (e.target === modalPedido) cerrarModal(modalPedido);
  if (e.target === modalUrls) cerrarModal(modalUrls);
};

let offset = 0;
let lastAgrupacion = null; // guarda la agrupaci√≥n actual para poder regresar

/* Normalizar nombre para mapear archivos */
function normalizar(s){ return s ? s.toString().trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'') : ''; }

/* Mapa cargado desde la base: nombre_normalizado -> archivo/url */
let archivoCafeteria = {}; // se llenar√° desde la tabla 'cafeterias'

function formatoDia(fecha){
  return fecha.toLocaleDateString("es-MX",{weekday:"long",day:"numeric",month:"short"});
}
function abrirModal(modal){ modal.classList.add('open'); modal.setAttribute('aria-hidden','false'); }
function cerrarModal(modal){ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); }
function logDebug(obj){ debugLog.style.display = 'none'; debugLog.textContent = typeof obj === 'string' ? obj : JSON.stringify(obj,null,2); }

/* Cargar tabla de cafeter√≠as desde Supabase y construir el mapa */
async function cargarCafeterias(){
  try {
    const { data, error } = await supabase.from('cafeterias').select('id,name,archivo');
    if(error){ console.warn('No se pudo cargar cafeter√≠as:', error); return; }
    archivoCafeteria = {};
    (data || []).forEach(row => {
      const clave = normalizar(row.name || row.id || '');
      archivoCafeteria[clave] = row.archivo || null;
    });
    logDebug({ cafeterias_loaded: Object.keys(archivoCafeteria).length });
  } catch (err) {
    console.error('Error en cargarCafeterias:', err);
  }
}

/* Cargar pedidos y renderizar d√≠as */
async function cargarPedidos(){
  try {
    await cargarCafeterias(); // aseguramos mapa actualizado

    const { data, error } = await supabase.from("pedidos").select("id,cafeteria,fecha,dias").order("fecha",{ascending:false});
    if(error){ console.error(error); logDebug("Error Supabase: "+JSON.stringify(error)); return; }
    const lastData = data || [];
    logDebug(lastData);

    container.innerHTML = "";
    const hoy = new Date();
    for(let i=0;i<6;i++){
      const fecha = new Date(hoy);
      fecha.setDate(hoy.getDate()+i+offset);
      const diaTexto = formatoDia(fecha);

      const card = document.createElement("div");
      card.className = "day-card";
      const main = document.createElement('div');
      main.textContent = diaTexto;
      const sub = document.createElement('small');
      sub.textContent = new Date(fecha).toLocaleDateString('es-ES');
      card.appendChild(main);
      card.appendChild(sub);

      const pedidosDia = (lastData || []).filter(p=>{
        try { return new Date(p.fecha).toDateString() === fecha.toDateString(); } catch(e){ return false; }
      });

      if(pedidosDia.length>0) card.classList.add("verde");

      card.addEventListener('click', () => {
        abrirModalCafeterias(pedidosDia, fecha);
      });

      container.appendChild(card);
    }
  } catch (err) {
    console.error("Error cargarPedidos:", err);
    logDebug("Excepci√≥n: "+String(err));
  }
}

/* Modal 1: mostrar tarjetas por cafeter√≠a */
function abrirModalCafeterias(pedidosDia, fecha){
  cafListEl.innerHTML = "";
  modalCafsNote.textContent = `Pedidos para ${formatoDia(fecha)} ‚Äî toca una cafeter√≠a para ver el pedido.`;

  if(!pedidosDia || pedidosDia.length === 0){
    cafListEl.innerHTML = "<p>No hay pedidos para este d√≠a.</p>";
    abrirModal(modalCafs);
    return;
  }

  // Agrupar por cafeter√≠a (nombre normalizado)
  const agrup = {};
  pedidosDia.forEach(p => {
    const clave = normalizar(p.cafeteria || 'sin-nombre');
    if(!agrup[clave]) agrup[clave] = [];
    agrup[clave].push(p);
  });

  // Guardar agrupaci√≥n para poder regresar desde detalle y para modal URLs
  lastAgrupacion = { agrup, fecha };

  Object.keys(agrup).forEach(clave => {
    const pedidos = agrup[clave];
    const nombreReal = pedidos[0].cafeteria || clave;

    const card = document.createElement('div');
    card.className = 'caf-card';
    const h = document.createElement('h4'); h.textContent = nombreReal;
    const p = document.createElement('p');

    let totalItems = 0;
    const sucursales = new Set();
    pedidos.forEach(pp => {
      const dias = pp.dias || {};
      const diasObj = Array.isArray(dias) ? { "Sin dia": dias } : dias;
      Object.keys(diasObj).forEach(dk=>{
        const val = diasObj[dk];
        if(Array.isArray(val)){
          val.forEach(it => totalItems += Number(it.cantidad || 0));
        } else if (val && typeof val === 'object'){
          Object.keys(val).forEach(suc=>{
            sucursales.add(suc);
            const arr = val[suc];
            if(Array.isArray(arr)) arr.forEach(it => totalItems += Number(it.cantidad || 0));
          });
        }
      });
    });
    p.textContent = `${totalItems} unidades ¬∑ ${Array.from(sucursales).join(', ') || '1 sucursal'}`;

    card.appendChild(h);
    card.appendChild(p);

    card.addEventListener('click', () => {
      abrirModalPedido(nombreReal, pedidos);
    });

    cafListEl.appendChild(card);
  });

  abrirModal(modalCafs);
}

/* Bot√≥n "Ver URLs" abre modal con enlaces de la agrupaci√≥n actual (local al d√≠a) */
btnVerUrls.addEventListener('click', () => {
  urlsListEl.innerHTML = "";
  urlsNote.textContent = "";
  if(!lastAgrupacion || !lastAgrupacion.agrup){
    urlsNote.textContent = "No hay cafeter√≠as disponibles para mostrar.";
    abrirModal(modalUrls);
    return;
  }

  const agrup = lastAgrupacion.agrup;
  const fecha = lastAgrupacion.fecha;
  urlsNote.textContent = `URLs para pedidos de ${formatoDia(fecha)} ‚Äî abre en nueva pesta√±a.`;

  Object.keys(agrup).forEach(clave => {
    const pedidos = agrup[clave];
    const nombreReal = pedidos[0].cafeteria || clave;
    const archivo = archivoCafeteria[clave] || null;

    const li = document.createElement('li');
    const span = document.createElement('span');
    span.textContent = nombreReal;

    const right = document.createElement('div');
    right.style.display = 'flex';
    right.style.gap = '8px';
    right.style.alignItems = 'center';

    if(archivo){
      const a = document.createElement('a');
      a.href = archivo.startsWith('http') ? archivo : `Gestor2b2/${archivo}`;
      a.target = '_blank';
      a.rel = 'noopener';
      a.className = 'url-link';
      a.textContent = 'Abrir';
      right.appendChild(a);
    } else {
      const no = document.createElement('span');
      no.textContent = 'Sin p√°gina';
      no.style.color = '#a00';
      no.style.fontSize = '13px';
      right.appendChild(no);
    }

    li.appendChild(span);
    li.appendChild(right);
    urlsListEl.appendChild(li);
  });

  abrirModal(modalUrls);
});

/* Nuevo: bot√≥n junto a Refrescar que muestra todas las URLs de cafeter√≠as (base de datos) */
openAllUrlsBtn.addEventListener('click', async () => {
  urlsListEl.innerHTML = "";
  urlsNote.textContent = "Todas las URLs registradas en la base de datos ‚Äî abre en nueva pesta√±a.";

  // Asegurarse de tener el mapa actualizado
  await cargarCafeterias();

  // Si no hay cafeter√≠as cargadas
  const claves = Object.keys(archivoCafeteria || {});
  if(claves.length === 0){
    urlsNote.textContent = "No se encontraron cafeter√≠as registradas.";
    abrirModal(modalUrls);
    return;
  }

  // Mostrar todas las cafeter√≠as ordenadas por nombre
  claves.sort().forEach(clave => {
    const archivo = archivoCafeteria[clave];
    const displayName = clave; // clave ya normalizada; si quieres el nombre original, necesitar√≠amos traerlo en cargarCafeterias
    const li = document.createElement('li');
    const span = document.createElement('span');
    span.textContent = displayName;

    const right = document.createElement('div');
    right.style.display = 'flex';
    right.style.gap = '8px';
    right.style.alignItems = 'center';

    if(archivo){
      const a = document.createElement('a');
      a.href = archivo.startsWith('http') ? archivo : `Gestionp2p/${archivo}`;
      a.target = '_blank';
      a.rel = 'noopener';
      a.className = 'url-link';
      a.textContent = 'Abrir';
      right.appendChild(a);
    } else {
      const no = document.createElement('span');
      no.textContent = 'Sin p√°gina';
      no.style.color = '#a00';
      no.style.fontSize = '13px';
      right.appendChild(no);
    }

    li.appendChild(span);
    li.appendChild(right);
    urlsListEl.appendChild(li);
  });

  abrirModal(modalUrls);
});

/* Modal 2: detalle de pedido */
function abrirModalPedido(nombre, pedidosArray){
  pedidoContent.innerHTML = "";
  const title = document.createElement('h2');
  title.id = 'modal-pedido-title';
  title.textContent = `Pedido ‚Äî ${nombre}`;
  pedidoContent.appendChild(title);

  pedidosArray.forEach((p, idx) => {
    const cont = document.createElement('div');
    cont.className = 'detalle';
    const sub = document.createElement('h3');
    sub.textContent = `Registro ${idx+1} ‚Äî ${new Date(p.fecha).toLocaleString()}`;
    cont.appendChild(sub);

    const dias = p.dias || {};
    const diasObj = Array.isArray(dias) ? { "Sin dia": dias } : dias;

    Object.keys(diasObj).forEach(diaKey => {
      const valor = diasObj[diaKey];
      const diaTitle = document.createElement('h4');
      diaTitle.textContent = diaKey;
      diaTitle.style.margin = '8px 0 6px';
      cont.appendChild(diaTitle);

      if(Array.isArray(valor)){
        const ul = document.createElement('ul');
        valor.forEach(it => {
          const li = document.createElement('li');
          li.textContent = `${it.producto ?? '‚Äî'} ‚Äî ${it.cantidad ?? 0}`;
          ul.appendChild(li);
        });
        cont.appendChild(ul);
      } else if(valor && typeof valor === 'object'){
        Object.keys(valor).forEach(suc => {
          const sucTitle = document.createElement('h5');
          sucTitle.textContent = suc;
          sucTitle.style.margin = '6px 0 4px';
          sucTitle.style.fontSize = '14px';
          sucTitle.style.color = 'var(--muted)';
          cont.appendChild(sucTitle);

          const arr = valor[suc];
          if(Array.isArray(arr)){
            const ul = document.createElement('ul');
            arr.forEach(it => {
              const li = document.createElement('li');
              li.textContent = `${it.producto ?? '‚Äî'} ‚Äî ${it.cantidad ?? 0}`;
              ul.appendChild(li);
            });
            cont.appendChild(ul);
          } else {
            const pErr = document.createElement('p');
            pErr.textContent = 'Formato inesperado en sucursal';
            pErr.style.color = '#a00';
            cont.appendChild(pErr);
          }
        });
      } else {
        const pErr = document.createElement('p');
        pErr.textContent = 'Formato inesperado en d√≠a';
        pErr.style.color = '#a00';
        cont.appendChild(pErr);
      }
    });

    pedidoContent.appendChild(cont);
  });

  cerrarModal(modalCafs);
  abrirModal(modalPedido);
}

/* Navegaci√≥n */
document.getElementById('prev').onclick = () => { offset -= 6; cargarPedidos(); };
document.getElementById('next').onclick = () => { offset += 6; cargarPedidos(); };

/* Refrescar (recarga suave) */
refreshBtn.addEventListener('click', () => {
  refreshBtn.disabled = true;
  const original = refreshBtn.textContent;
  refreshBtn.textContent = 'Actualizando‚Ä¶';
  Promise.resolve().then(() => cargarPedidos())
    .finally(() => {
      setTimeout(() => {
        refreshBtn.textContent = original;
        refreshBtn.disabled = false;
      }, 600);
    });
});

/* Realtime (debounce simple) */
supabase.channel("pedidos-changes")
  .on("postgres_changes",{event:"INSERT",schema:"public",table:"pedidos"},payload=>{
    setTimeout(()=> cargarPedidos(), 300);
  })
  .subscribe();

/* Inicializar */
cargarPedidos();
</script>
</body>
</html>
