<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Pedidos</title>
<style>
body {
  font-family: Arial, sans-serif;
  background:#f8f8f8;
  padding:20px;
  margin:0;
}
h1 {
  text-align:center;
  color:#2c3e50;
  margin-bottom:10px;
  font-size:32px;
}
.controls {
  text-align:center;
  margin-bottom:20px;
}
button {
  padding:10px 20px;
  margin:0 10px;
  font-size:16px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  background:#2c3e50;
  color:#fff;
}
.days {
  display:grid;
  grid-template-columns: repeat(3, 1fr);
  grid-template-rows: repeat(2, 1fr);
  gap:25px;
  height:75vh;
  padding:10px;
}
.day-card {
  border:1px solid #ccc;
  border-radius:18px;
  background:#fff;
  text-align:center;
  cursor:pointer;
  font-size:28px;
  font-weight:bold;
  display:flex;
  justify-content:center;
  align-items:center;
  box-shadow:0 4px 10px rgba(0,0,0,0.1);
  transition:transform 0.2s ease, background 0.2s ease;
}
.day-card:hover { transform:scale(1.03); }
.day-card.verde { background:#27ae60; color:#fff; }
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; }
.modal-content { background:#fff; padding:20px; border-radius:12px; max-width:90%; max-height:90%; overflow:auto; }
.close { float:right; cursor:pointer; font-size:28px; }
.modal-content h3 { margin-top:15px; color:#2c3e50; }
.modal-content ul { list-style:none; padding:0; }
.modal-content li { padding:5px 0; border-bottom:1px solid #eee; }
.debug { font-family:monospace; font-size:12px; color:#333; margin-top:12px; white-space:pre-wrap; max-height:120px; overflow:auto; background:#fff; padding:8px; border-radius:8px; border:1px solid #eee; }
@media (max-width:720px){
  .days { grid-template-columns: 1fr; height:auto; }
  .day-card { font-size:20px; padding:18px; min-height:72px; }
}
</style>
</head>
<body>

<h1>Dashboard de Pedidos</h1>
<div class="controls">
  <button id="prev">◀ Anterior</button>
  <button id="next">Siguiente ▶</button>
</div>
<div class="days" id="days-container"></div>

<div class="modal" id="modal">
  <div class="modal-content">
    <span class="close" id="close">&times;</span>
    <div id="modal-body"></div>
  </div>
</div>

<div id="debug-log" class="debug" style="display:none;"></div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const SUPABASE_URL = "https://pqphzdodpassomggthid.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBxcGh6ZG9kcGFzc29tZ2d0aGlkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1ODMxMTIsImV4cCI6MjA4MzE1OTExMn0.mQNeavAOItO-wTgfGVac-z91baYxsa6866HpBOZy3nM";
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

const container = document.getElementById("days-container");
const modal = document.getElementById("modal");
const modalBody = document.getElementById("modal-body");
const closeBtn = document.getElementById("close");
const prevBtn = document.getElementById("prev");
const nextBtn = document.getElementById("next");
const debugLog = document.getElementById("debug-log");

closeBtn.onclick = () => modal.style.display = "none";
window.onclick = e => { if (e.target === modal) modal.style.display = "none"; };

let offset = 0;

function formatoDia(fecha){
  return fecha.toLocaleDateString("es-MX",{weekday:"long",day:"numeric",month:"short"});
}

// Mapa nombre de cafetería -> archivo (ajusta si los nombres en la BD difieren)
const archivoCafeteria = {
  "breck": "breck.html",
  "amin": "amin.html",
  "zuzu": "zuzu.html",
  "ponke": "ponke.html",
  "cafe del sur": "cafe-del-sur.html"
};

function logDebug(obj){
  try {
    debugLog.style.display = "block";
    debugLog.textContent = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
    console.log(obj);
  } catch(e){ console.log("debug error", e); }
}

async function cargarPedidos(){
  try {
    const { data, error } = await supabase.from("pedidos").select("*").order("fecha",{ascending:false});
    if(error){ console.error(error); logDebug("Error al consultar Supabase: " + JSON.stringify(error)); return; }
    container.innerHTML = "";

    // mostrar datos crudos en debug (oculto por defecto)
    logDebug(data || []);

    const hoy = new Date();
    for(let i=0;i<6;i++){
      const fecha = new Date(hoy);
      fecha.setDate(hoy.getDate()+i+offset);
      const diaTexto = formatoDia(fecha);

      const card = document.createElement("div");
      card.className = "day-card";
      card.textContent = diaTexto;

      const pedidosDia = (data || []).filter(p=>{
        try { return new Date(p.fecha).toDateString() === fecha.toDateString(); }
        catch(e){ return false; }
      });

      if(pedidosDia.length>0){ card.classList.add("verde"); }

      card.onclick = () => {
        modalBody.innerHTML = "";
        if(pedidosDia.length === 0){
          modalBody.innerHTML = "<p>No hay pedidos para este día.</p>";
        } else {
          pedidosDia.forEach(p=>{
            // depuración: mostrar estructura de p.dias
            console.log("Pedido recibido:", p);
            const div = document.createElement("div");
            div.innerHTML = `<h3>${p.cafeteria ?? 'Sin nombre'}</h3>`;

            // Normalizar nombre y buscar archivo
            const nombreNorm = (p.cafeteria || "").toString().trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
            const archivo = archivoCafeteria[nombreNorm];
            if(archivo){
              const abrir = document.createElement("a");
              abrir.href = `Gestor2b2/${archivo}`;
              abrir.target = "_blank";
              abrir.rel = "noopener";
              abrir.textContent = "Abrir página de la cafetería";
              abrir.style.display = "inline-block";
              abrir.style.margin = "8px 0";
              div.appendChild(abrir);
            } else {
              const nota = document.createElement("p");
              nota.textContent = `No se encontró página para "${p.cafeteria}" (normalizado: "${nombreNorm}")`;
              nota.style.color = "#a00";
              div.appendChild(nota);
            }

            // Manejo defensivo de p.dias
            const lista = document.createElement("ul");
            const dias = p.dias || {};
            const diasObj = Array.isArray(dias) ? { "Sin dia": dias } : dias;

            Object.keys(diasObj).forEach(diaKey => {
              const valor = diasObj[diaKey];

              // Caso A: valor es array de items
              if (Array.isArray(valor)) {
                valor.forEach(item => {
                  const li = document.createElement("li");
                  li.textContent = `${diaKey} — ${item.producto ?? '—'} — ${item.cantidad ?? 0}`;
                  lista.appendChild(li);
                });
                return;
              }

              // Caso B: valor es objeto por sucursales
              if (valor && typeof valor === "object") {
                Object.keys(valor).forEach(sucursal => {
                  const arr = valor[sucursal];
                  if (Array.isArray(arr)) {
                    arr.forEach(item => {
                      const li = document.createElement("li");
                      li.textContent = `${diaKey} / ${sucursal} — ${item.producto ?? '—'} — ${item.cantidad ?? 0}`;
                      lista.appendChild(li);
                    });
                  } else {
                    const li = document.createElement("li");
                    li.textContent = `${diaKey} / ${sucursal} — formato inesperado`;
                    lista.appendChild(li);
                    console.warn("Sucursal no es array:", diaKey, sucursal, arr);
                  }
                });
                return;
              }

              // Caso C: formato inesperado
              const li = document.createElement("li");
              li.textContent = `${diaKey} — formato inesperado: ${String(valor)}`;
              lista.appendChild(li);
              console.warn("Formato inesperado en p.dias:", diaKey, valor);
            });

            div.appendChild(lista);
            modalBody.appendChild(div);
          });
        }
        modal.style.display = "flex";
      };

      container.appendChild(card);
    }
  } catch (err) {
    console.error("Error en cargarPedidos:", err);
    logDebug("Excepción en cargarPedidos: " + String(err));
  }
}

prevBtn.onclick = () => { offset -= 6; cargarPedidos(); };
nextBtn.onclick = () => { offset += 6; cargarPedidos(); };

cargarPedidos();

supabase.channel("pedidos-changes")
  .on("postgres_changes",{event:"INSERT",schema:"public",table:"pedidos"},payload=>{
    // debounce simple para evitar recargas muy rápidas
    setTimeout(()=> cargarPedidos(), 300);
  })
  .subscribe();
</script>

</body>
</html>
